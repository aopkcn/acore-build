name: Ëá™Âä®ÁºñËØë

on:
  workflow_dispatch:
  # schedule:  
  #- cron: "30 22 * * *"
<<<<<<< HEAD
  # - cron: "0 * * * *"  # √ø–° ±÷¥––“ª¥Œ
=======
  - cron: "0 * * * *"  # ÊØèÂ∞èÊó∂ÊâßË°å‰∏ÄÊ¨?
>>>>>>> cd35b66783dd68d3564ebe0e4f9c9d6c8fca3f26
  push:
    branches: [build]
    paths:
    - 'Version.txt'
    # paths-ignore:
    #   - 'Version.txt'
    #   - 'README.md'

#concurrency:
 # group: ${{ github.workflow }})
  #cancel-in-progress: true

jobs:
  version-check:
    name: Ê£ÄÊü•ÁâàÊú?
    runs-on: ubuntu-20.04
    outputs:
      isazerothcore: ${{ steps.update_switch.outputs.isazerothcore }}
      isplayerbot: ${{ steps.update_switch.outputs.isplayerbot }}
    steps:
      - name: Ê£ÄÊü•Êèê‰∫?ID ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ?
        id: update_switch
        run: |
            AC_ID=$(curl -s https://api.github.com/repos/azerothcore/azerothcore-wotlk/commits/master?per_page=1 | jq -r '.sha')
            LAC_ID=$(curl -s https://raw.githubusercontent.com/aopkcn/acore-build/build/Version.txt | sed -n 's/^Azerothcore=//p')
            BOT_ID=$(curl -s https://api.github.com/repos/liyunfan1223/azerothcore-wotlk/commits/Playerbot?per_page=1 | jq -r '.sha')
            LBOT_ID=$(curl -s https://raw.githubusercontent.com/aopkcn/acore-build/build/Version.txt | sed -n 's/^Playerbot=//p')
<<<<<<< HEAD
           
            echo "◊Ó–¬AC: $AC_ID ±æµÿAC: $LAC_ID"
            echo "◊Ó–¬BOT: $BOT_ID ±æµÿBOT: $LBOT_ID"

            if [ -z "$AC_ID" ] || [ -z "$BOT_ID" ]; then
                echo "AC_ID ªÚ BOT_ID ≤ªƒ‹Œ™ø’£¨«ÎºÏ≤È≈‰÷√"
                exit 1  
            fi
=======
            curl -s -L -o Version.txt https://raw.githubusercontent.com/aopkcn/acore-build/build/Version.txt
            echo "ÊúÄÊñ∞AC: $AC_ID ‰øùÂ≠òAC: $LAC_ID"
            echo "ÊúÄÊñ∞BOT: $BOT_ID ‰øùÂ≠òBOT: $LBOT_ID"
    
            message=""
>>>>>>> cd35b66783dd68d3564ebe0e4f9c9d6c8fca3f26
            if [ "$AC_ID" == "$LAC_ID" ] && [ "$BOT_ID" == "$LBOT_ID" ]; then
                echo "ÂΩìÂâçÊèê‰∫§ ID Â∑≤ÊòØÊúÄÊñ∞ÔºåÊó†ÈúÄÊõ¥Êñ∞"
                echo "isazerothcore=true" >> $GITHUB_OUTPUT
                echo "isplayerbot=true" >> $GITHUB_OUTPUT
            else
                if [ "$AC_ID" != "$LAC_ID" ]; then
                    echo "AC Êèê‰∫§ ID ‰∏ç‰∏ÄËá¥ÔºåÈúÄË¶ÅÊõ¥Êñ?
                    echo "isazerothcore=false" >> $GITHUB_OUTPUT
<<<<<<< HEAD
=======
                    sed -i "s/^Azerothcore=.*/Azerothcore=$AC_ID/" Version.txt
                    message="Êõ¥Êñ∞AzerothcoreÊèê‰∫§ID:$AC_ID \n"
>>>>>>> cd35b66783dd68d3564ebe0e4f9c9d6c8fca3f26
                fi
                if [ "$BOT_ID" != "$LBOT_ID" ]; then
                    echo "BOT Êèê‰∫§ ID ‰∏ç‰∏ÄËá¥ÔºåÈúÄË¶ÅÊõ¥Êñ?
                    echo "isplayerbot=false" >> $GITHUB_OUTPUT
<<<<<<< HEAD
=======
                    sed -i "s/^Playerbot=.*/Playerbot=$BOT_ID/" Version.txt
                    if [ -n "$message" ]; then
                        message="$message Êõ¥Êñ∞PlayerbotÊèê‰∫§ID:$BOT_ID"
                    else
                        message="Êõ¥Êñ∞PlayerbotÊèê‰∫§ID:$BOT_ID"
                    fi
>>>>>>> cd35b66783dd68d3564ebe0e4f9c9d6c8fca3f26
                fi
            fi

  ac-docker-build:
    name: ACdockerÁºñËØë
    needs: version-check
    if: ${{ needs.version-check.outputs.isazerothcore == 'false' }}
    runs-on: ubuntu-20.04
    steps:
      - name: ÊãâÂèñÊ†∏ÂøÉ‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/azerothcore-wotlk'
          ref: 'master'

      - name: ÊãâÂèñÂΩìÂâçÈ°πÁõÆ
        uses: actions/checkout@v4
        with:
          ref: 'build'
          path: 'build'

      - name: ÊãâÂèñEluna‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/mod-eluna'  
          ref: 'master'
          path: 'modules/mod-eluna'

      - name: ‰∏ãËΩΩÂπ∂ÊõøÊç¢MotdMgr.cpp
        run: |
          curl -L -o MotdMgr.cpp https://raw.githubusercontent.com/aopkcn/acore-build/build/MotdMgr.cpp
          mv -f MotdMgr.cpp src/server/game/Motd/MotdMgr.cpp

      - name: ÁôªÂΩïDockerÂÆπÂô®ÊúçÂä°
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} 
          password: ${{ secrets.DOCKERHUB_TOKEN }} 

      - name: ÁôªÂΩïGitHubÂÆπÂô®ÊúçÂä°
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}

      - name: ÁôªÂΩïÈòøÈáå‰∫ëÂÆπÂô®ÊúçÂä?
        uses: docker/login-action@v3
        with:
          registry: registry.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALYUN_NAME }}
          password: ${{ secrets.ALYUN_TOKEN }}

      - name: ËÆæÁΩÆÁºñËØëÁâàÊú¨
        id: version
        run: |
            version=$(curl -s https://api.github.com/repos/azerothcore/azerothcore-wotlk/commits/master?per_page=1 | jq -r '.sha')
            echo "version=$version" >> $GITHUB_OUTPUT

      - name: ËÆæÁΩÆ Docker Buildx ÁéØÂ¢É
        uses: docker/setup-buildx-action@v3

      - name: ÁºñËØë worldserver 
        uses: ./build/.github/ac_docker-build 
        with:
          component-name: worldserver 
          version: ${{ steps.version.outputs.version }} 
          push: true 

      - name: ÁºñËØë authserver 
        uses: ./build/.github/ac_docker-build
        with:
          component-name: authserver
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë db-import 
        uses: ./build/.github/ac_docker-build
        with:
          component-name: db-import
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë client-data
        uses: ./build/.github/ac_docker-build
        with:
          component-name: client-data
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë tools
        uses: ./build/.github/ac_docker-build
        with:
          component-name: tools
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë dev-server
        uses: ./build/.github/ac_docker-build
        with:
          component-name: dev
          version: ${{ steps.version.outputs.version }}
          push: true
          dockerfile: apps/docker/Dockerfile.dev-server


  ac-windows-build:
    name: ACWin64ÁºñËØë
    needs: version-check
    if: ${{ needs.version-check.outputs.isazerothcore == 'false' }}
    runs-on: windows-latest
    env:
      BOOST_ROOT: C:\local\boost_1_82_0
    steps:
      - name: ÊãâÂèñÊ†∏ÂøÉ‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/azerothcore-wotlk'
          ref: 'master'

      - name: ÊãâÂèñÂΩìÂâçÈ°πÁõÆ
        uses: actions/checkout@v4
        with:
          ref: 'build'
          path: 'build'

      - name: ÊãâÂèñEluna‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/mod-eluna'  
          ref: 'master'
          path: 'modules/mod-eluna'

      - name: ‰∏ãËΩΩÂπ∂ÊõøÊç¢MotdMgr.cpp
        run: |
          curl -L -o MotdMgr.cpp https://raw.githubusercontent.com/aopkcn/acore-build/master/MotdMgr.cpp
          Move-Item -Path MotdMgr.cpp -Destination src/server/game/Motd/MotdMgr.cpp -Force


      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.13
      - name: Configure OS
        shell: bash
        env:
          CONTINUOUS_INTEGRATION: true
        run: |
          ./acore.sh install-deps
      - name: ÁºñËØë
        shell: bash
        run: |
          export CTOOLS_BUILD=all
          # export CTYPE=RelWithDebInfo
          ./acore.sh compiler build
      - name: ÊâìÂåÖÁºñËØëÊñá‰ª∂
        run: |
    
            mkdir -p AzerothCoreWotlk-Win64\lua_scripts
            mkdir -p AzerothCoreWotlk-Win64\data

            Copy-Item -Path "C:\Program Files\OpenSSL\bin\legacy.dll" -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path "C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll" -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path "C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll" -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path C:\tools\mysql\current\lib\libmysql.dll -Destination AzerothCoreWotlk-Win64
           
            Copy-Item -Path data\sql -Destination AzerothCoreWotlk-Win64\data -Recurse -Force
            Copy-Item -Path env\dist\configs -Destination AzerothCoreWotlk-Win64 -Recurse -Force
            Copy-Item -Path env\dist\authserver.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\worldserver.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\dbimport.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\map_extractor.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\mmaps_generator.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\vmap4_assembler.exe -Destination AzerothCoreWotlk-Win64
            Copy-Item -Path env\dist\vmap4_extractor.exe -Destination AzerothCoreWotlk-Win64

            Compress-Archive -Path AzerothCoreWotlk-Win64 -DestinationPath AC-Win.zip

      #       Move-Item -Path C:\Program Files\OpenSSL\bin\legacy.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\tools\mysql\current\lib\libmysql.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Compress-Archive -Path var\build\obj\bin\RelWithDebInfo\* -DestinationPath AC-Win.zip
      - name: ‰∏ä‰º†WindowsÁºñËØëÊñá‰ª∂
        uses: actions/upload-artifact@v4
        with:
         name: AzerothCoreWotlk-Win64
         path: AzerothCoreWotlk-Win64

  ac-bot-docker-build:
    name: ACÊú∫Âô®‰∫∫dockerÁºñËØë
    needs: version-check
    if: ${{ needs.version-check.outputs.isplayerbot == 'false' }}
    runs-on: ubuntu-20.04
    steps:
      - name: ÊãâÂèñÊ†∏ÂøÉ‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'liyunfan1223/azerothcore-wotlk'
          ref: 'Playerbot'

      - name: ÊãâÂèñÂΩìÂâçÈ°πÁõÆ
        uses: actions/checkout@v4
        with:
          ref: 'build'
          path: 'build'

      - name: ÊãâÂèñEluna‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/mod-eluna'  
          ref: 'master'
          path: 'modules/mod-eluna'

      - name: ÊãâÂèñplayerbots‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'liyunfan1223/mod-playerbots'  
          ref: 'master'
          path: 'modules/mod-playerbots'

      - name: ‰∏ãËΩΩÂπ∂ÊõøÊç¢MotdMgr.cpp
        run: |
          curl -L -o MotdMgr.cpp https://raw.githubusercontent.com/aopkcn/acore-build/build/MotdMgr.cpp
          mv -f MotdMgr.cpp src/server/game/Motd/MotdMgr.cpp

      - name: ÁôªÂΩïDockerÂÆπÂô®ÊúçÂä°
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} 
          password: ${{ secrets.DOCKERHUB_TOKEN }} 

      - name: ÁôªÂΩïGitHubÂÆπÂô®ÊúçÂä°
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}

      - name: ÁôªÂΩïÈòøÈáå‰∫ëÂÆπÂô®ÊúçÂä?
        uses: docker/login-action@v3
        with:
          registry: registry.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALYUN_NAME }}
          password: ${{ secrets.ALYUN_TOKEN }}


      - name: ËÆæÁΩÆÁºñËØëÁâàÊú¨
        id: version
        run: |
          version=$(curl -s https://api.github.com/repos/liyunfan1223/azerothcore-wotlk/commits/Playerbot?per_page=1 | jq -r '.sha')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ËÆæÁΩÆ Docker Buildx ÁéØÂ¢É
        uses: docker/setup-buildx-action@v3

      - name: ÁºñËØë worldserver 
        uses: ./build/.github/ac_bot_docker-build 
        with:
          component-name: worldserver
          version: ${{ steps.version.outputs.version }} 
          push: true 

      - name: ÁºñËØë authserver 
        uses: ./build/.github/ac_bot_docker-build
        with:
          component-name: authserver
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë db-import 
        uses: ./build/.github/ac_bot_docker-build
        with:
          component-name: db-import
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë client-data
        uses: ./build/.github/ac_bot_docker-build
        with:
          component-name: client-data
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë tools
        uses: ./build/.github/ac_bot_docker-build
        with:
          component-name: tools
          version: ${{ steps.version.outputs.version }}
          push: true

      - name: ÁºñËØë dev-server
        uses: ./build/.github/ac_bot_docker-build
        with:
          component-name: dev
          version: ${{ steps.version.outputs.version }}
          push: true
          dockerfile: apps/docker/Dockerfile.dev-server


  ac-bot-windows-build:
    name: ACÊú∫Âô®‰∫∫Win64ÁºñËØë
    needs: version-check
    if: ${{ needs.version-check.outputs.isplayerbot == 'false' }}
    runs-on: windows-latest
    env:
      BOOST_ROOT: C:\local\boost_1_82_0
    steps:
      - name: ÊãâÂèñÊ†∏ÂøÉ‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'liyunfan1223/azerothcore-wotlk'
          ref: 'Playerbot'

      - name: ÊãâÂèñÂΩìÂâçÈ°πÁõÆ
        uses: actions/checkout@v4
        with:
          ref: 'build'
          path: 'build'

      - name: ÊãâÂèñEluna‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'azerothcore/mod-eluna'  
          ref: 'master'
          path: 'modules/mod-eluna'

      - name: ÊãâÂèñplayerbots‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          repository: 'liyunfan1223/mod-playerbots'  
          ref: 'master'
          path: 'modules/mod-playerbots'

      - name: ‰∏ãËΩΩÂπ∂ÊõøÊç¢MotdMgr.cpp
        run: |
          curl -L -o MotdMgr.cpp https://raw.githubusercontent.com/aopkcn/acore-build/build/MotdMgr.cpp
          Move-Item -Path MotdMgr.cpp -Destination src/server/game/Motd/MotdMgr.cpp -Force

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.13
      - name: Configure OS
        shell: bash
        env:
          CONTINUOUS_INTEGRATION: true2
        run: |
          ./acore.sh install-deps
      - name: ÁºñËØë
        shell: bash
        run: |
          export CTOOLS_BUILD=all
          # export CTYPE=RelWithDebInfo
          ./acore.sh compiler build
      - name: ÊâìÂåÖÁºñËØëÊñá‰ª∂
        run: |
            mkdir -p AzerothCoreWotlkBot-Win64\modules\mod-playerbots\data
            mkdir -p AzerothCoreWotlkBot-Win64\lua_scripts
            mkdir -p AzerothCoreWotlkBot-Win64\data

            Copy-Item -Path "C:\Program Files\OpenSSL\bin\legacy.dll" -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path "C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll" -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path "C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll" -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path "C:\tools\mysql\current\lib\libmysql.dll" -Destination AzerothCoreWotlkBot-Win64
           
            Copy-Item -Path modules\mod-playerbots\data\sql -Destination AzerothCoreWotlkBot-Win64\modules\mod-playerbots\data\sql -Recurse -Force
            Copy-Item -Path data\sql -Destination AzerothCoreWotlkBot-Win64\data -Recurse -Force
            Copy-Item -Path env\dist\configs -Destination AzerothCoreWotlkBot-Win64 -Recurse -Force
            Copy-Item -Path env\dist\authserver.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\worldserver.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\dbimport.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\map_extractor.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\mmaps_generator.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\vmap4_assembler.exe -Destination AzerothCoreWotlkBot-Win64
            Copy-Item -Path env\dist\vmap4_extractor.exe -Destination AzerothCoreWotlkBot-Win64

            Compress-Archive -Path AzerothCoreWotlkBot-Win64 -DestinationPath AC-Bot-Win.zip

      #       Move-Item -Path C:\Program Files\OpenSSL\bin\legacy.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\Program Files\OpenSSL\bin\libcrypto-1_1-x64.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\Program Files\OpenSSL\bin\libssl-1_1-x64.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Move-Item -Path C:\tools\mysql\current\lib\libmysql.dll -Destination var\build\obj\bin\RelWithDebInfo
      #       Compress-Archive -Path var\build\obj\bin\RelWithDebInfo\* -DestinationPath AC-Bot-Win.zip
      - name: ‰∏ä‰º† Windows ÁºñËØëÊñá‰ª∂
        uses: actions/upload-artifact@v4
        with:
         name: AzerothCoreWotlkBot-Win64
         path: AzerothCoreWotlkBot-Win64
